from scapy.all import *
from scapy.layers.smb import SMBHeader


def malware_exploit_indicators(pcap_file):
    packets = rdpcap(pcap_file)
    malformed_packets = []
    smb_exploits = []
    unusual_transfers = []

    for packet in packets:
        # Detect malformed packets
        if packet.haslayer(Raw) and len(packet[Raw].load) > 1500:  # MTU violation
            malformed_packets.append(packet.summary())

        # Detect SMB exploits (e.g., EternalBlue)
        if SMBHeader in packet:
            if packet[SMBHeader].flags & 0x01:  # Example flag check
                smb_exploits.append(packet.summary())

        # Detect unusual file transfers (e.g., non-standard ports)
        if TCP in packet and packet[TCP].dport not in [80, 443, 21, 22]:
            if packet.haslayer(Raw) and len(packet[Raw].load) > 1000:
                unusual_transfers.append(packet.summary())

    # Print results
    print(f"Malformed packets: {len(malformed_packets)}")
    print(f"SMB exploit attempts: {len(smb_exploits)}")
    print(f"Unusual file transfers: {len(unusual_transfers)}")


# Run the analysis
malware_exploit_indicators("example.pcap")
